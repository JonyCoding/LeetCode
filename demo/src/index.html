<!DOCTYPE html>
<html>
	<head>
		<title>Flowchart Example</title>
		<style>
			#canvas {
				width: 100%;
				height: 80vh;
				border: 1px solid #ccc;
			}
			.node {
				position: absolute;
				background-color: #ffffff;
				border: 2px solid #0051ff;
				border-radius: 5px;
				padding: 10px;
				cursor: move;
			}
			.explain {
				position: absolute;
				background-color: #0051ff;
				color: white;
				z-index: 10;
				padding: 2px 10px;
				cursor: move;
				border-radius: 20px;
			}
			.empty {
				background-color: #0051ff;
				position: absolute;
				width: 30px;
				height: 30px;
				cursor: move;
			}
		</style>
	</head>
	<body>
		<div id="canvas"></div>
		<button id="exportBtn">导出数据</button>
		<button id="addNodeBtn">添加节点</button>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
		<script src="https://cdn.bootcdn.net/ajax/libs/jsPlumb/2.9.3/js/jsplumb.min.js"></script>
		<script>
			// 流程图数据
			var flowchartData = [
				{
					id: "node1",
					top: 221,
					left: 76,
					label: "Node 1",
					type: "node",
				},
				{
					id: "node2",
					top: 36,
					left: 318,
					label: "Node 2",
					type: "node",
				},
				{
					id: "node3",
					top: 221,
					left: 308,
					label: "Node 3",
					type: "node",
				},
				{
					id: "node4",
					top: 350,
					left: 280,
					label: "Node 4",
					type: "node",
				},
				{
					id: "node5",
					top: 450,
					left: 300,
					label: "Node 5",
					type: "node",
				},
				{
					id: "node6",
					top: 110,
					left: 316,
					label: "Node 6",
					type: "node",
				},
				{
					id: "node7",
					top: 350,
					left: 360,
					label: "Node 7",
					type: "node",
				},
				{
					id: "node8",
					top: 350,
					left: 400,
					label: "Node 8",
					type: "node",
				},
				{
					id: "explain1",
					top: 232,
					left: 209,
					label: "126",
					type: "explain",
				},
				{
					id: "empty1",
					top: 118,
					left: 194,
					label: "",
					type: "empty",
				},
			];
			flowchartData = JSON.parse(window.localStorage.getItem("flowchartData")) || flowchartData;

			// 连接关系数据
			var connectionData = [
				{ source: "node1", target: "node2", sourceAnchor: "Right", targetAnchor: "Left" },
				{ source: "node1", target: "node3", sourceAnchor: "Bottom", targetAnchor: "Top" },
				{ source: "node4", target: "node5", sourceAnchor: "Right", targetAnchor: "Right" },
			];
			connectionData = JSON.parse(window.localStorage.getItem("connectionData")) || connectionData;

			// 初始化流程图
			jsPlumb.ready(function () {
				// 创建实例
				var instance = jsPlumb.getInstance();
				instance.bind("dblclick", function (connection, originalEvent) {
					if (confirm("Are you sure you want to delete this connection?")) {
						instance.deleteConnection(connection);
					}
				});
				// 设置连接线样式
				var connectorStyle = {
					strokeWidth: 2,
					stroke: "#555555",
					connector: ["Flowchart", { stub: 20 }],
					connectorEditable: true,
				};

				// 创建节点
				flowchartData.forEach(function (node) {
					var element = $("<div>")
						.attr("id", node.id)
						.attr("node-type", node.type)
						.addClass(node.type)
						.css({
							top: node.top + "px",
							left: node.left + "px",
						})
						.text(node.label);
					$("#canvas").append(element);
					// 可拖拽
					instance.draggable(element, {
						containment: "parent",
					});

					//自由创建连线

					var common = {
						isSource: true,
						isTarget: true,
						connector: ["Flowchart"],
						endpoint: "Dot",
						maxConnections: -1, // 设置为 -1 表示无连接数上限
						paintStyle: { fill: "#666666", radius: 7 }, // 端点的样式
						hoverPaintStyle: { fill: "#FF0000" }, // 端点悬停时的样式
						connectorStyle: { stroke: "#666666", strokeWidth: 2 }, // 连接线的样式
					};
					if (node.type === "node" || node.type === "empty") {
						// 使用 addEndpoints 函数添加端点
						instance.addEndpoints(
							node.id,
							[
								{ anchor: "Top", uuid: "nodeIdTopCenter" },
								{ anchor: "Bottom", uuid: "nodeIdBottomCenter" },
								{ anchor: "Left", uuid: "nodeIdLeftMiddle" },
								{ anchor: "Right", uuid: "nodeIdRightMiddle" },
							],
							common
						);
					}
					// 设置好连线后不可以再次拖拽
					jsPlumb.importDefaults({
						ConnectionsDetachable: false,
					});
				});

				// 创建连接
				connectionData.forEach(function (connection) {
					instance.connect({
						source: connection.source,
						target: connection.target,
						anchors: [connection.sourceAnchor, connection.targetAnchor],
						endpoint: "Dot",
						connector: ["Flowchart", { stub: 20 }],
						paintStyle: connectorStyle,
					});
				});

				// 导出数据按钮点击事件处理程序
				$("#exportBtn").click(function () {
					var nodes = $(".node,.explain,.empty");
					var flowchartData = [];

					nodes.each(function () {
						var id = $(this).attr("id");
						var top = parseInt($(this).css("top"));
						var left = parseInt($(this).css("left"));
						var label = $(this).text();
						var type = $(this).attr("node-type");
						console.log("$(this)", $(this).attr("node-type"));
						flowchartData.push({ id: id, top: top, left: left, label: label, type: type });
					});

					// 获取所有的连线数据
					var connections = instance.getConnections();
					var connectionData = [];

					connections.forEach(function (connection) {
						var sourceId = connection.sourceId;
						var targetId = connection.targetId;
						// 获取源和目标节点的锚点类型
						var sourceAnchorType = connection.endpoints[0].anchor.type;
						var targetAnchorType = connection.endpoints[1].anchor.type;

						connectionData.push({ source: sourceId, target: targetId, sourceAnchor: sourceAnchorType, targetAnchor: targetAnchorType });
						// connectionData.push({ source: sourceId, target: targetId });
					});

					// 暂时存在本地
					console.log("flowchartData", flowchartData);
					console.log("connectionData", connectionData);
					window.localStorage.setItem("flowchartData", JSON.stringify(flowchartData));
					window.localStorage.setItem("connectionData", JSON.stringify(connectionData));
				});
			});

			// 添加节点按钮点击事件处理程序
			$("#addNodeBtn").click(function () {
				var newNodeId = "node" + (flowchartData.length + 1);
				var newNode = {
					id: newNodeId,
					top: 150,
					left: 400,
					label: "Node " + (flowchartData.length + 1),
				};

				// 添加新节点到数据列表
				flowchartData.push(newNode);

				// 创建新节点的 DOM 元素并添加到画布
				var newElement = $("<div>")
					.attr("id", newNode.id)
					.addClass("node")
					.css({
						top: newNode.top + "px",
						left: newNode.left + "px",
					})
					.text(newNode.label);
				$("#canvas").append(newElement);

				// 可拖拽
				instance.draggable(newElement, {
					containment: "parent",
				});

				// 更新数据
				window.localStorage.setItem("flowchartData", JSON.stringify(flowchartData));
			});
		</script>
	</body>
</html>
