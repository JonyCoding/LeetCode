<!DOCTYPE html>
<html>
	<head>
		<title>Flowchart Example</title>
		<style>
			#canvas {
				width: 100%;
				height: 80vh;
				border: 1px solid #ccc;
			}
			.node {
				position: absolute;
				background-color: #ffffff;
				border: 1px solid #ccc;
				padding: 10px;
				cursor: move;
			}
		</style>
	</head>
	<body>
		<div id="canvas"></div>
		<button id="exportBtn">导出数据</button>
		<button id="addNodeBtn">添加节点</button>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
		<script src="https://cdn.bootcss.com/jsPlumb/2.6.8/js/jsplumb.min.js"></script>
		<script>
			// 流程图数据
			var flowchartData = [
				{ id: "node1", top: 100, left: 100, label: "Node 1", type: "node" },
				{ id: "node2", top: 100, left: 300, label: "Node 2", type: "node" },
				{ id: "node3", top: 250, left: 250, label: "Node 3", type: "node" },
				{ id: "node4", top: 350, left: 280, label: "Node 4", type: "node" },
				{ id: "node5", top: 450, left: 300, label: "Node 5", type: "node" },
				{ id: "node6", top: 250, left: 320, label: "Node 6", type: "node" },
				{ id: "node7", top: 350, left: 360, label: "Node 7", type: "node" },
				{ id: "node8", top: 350, left: 400, label: "Node 8", type: "node" },
				{ id: "explain1", top: 350, left: 400, label: "说明文字", type: "explain" },
			];
			flowchartData = JSON.parse(window.localStorage.getItem("flowchartData")) || flowchartData;

			// 连接关系数据
			var connectionData = [
				{ source: "node1", target: "node2" },
				{ source: "node1", target: "node3" },
				{ source: "node9", target: "node11" },
			];
			// connectionData = JSON.parse(window.localStorage.getItem("connectionData")) || connectionData;

			// 初始化流程图
			jsPlumb.ready(function () {
				// 创建实例
				var instance = jsPlumb.getInstance();

				// 设置连接线样式
				var connectorStyle = {
					strokeWidth: 2,
					stroke: "#555555",
				};

				// 创建节点
				flowchartData.forEach(function (node) {
					var element = $("<div>")
						.attr("id", node.id)
						.addClass("node")
						.css({
							top: node.top + "px",
							left: node.left + "px",
						})
						.text(node.label);
					$("#canvas").append(element);
					// 可拖拽
					instance.draggable(element, {
						containment: "parent",
					});
				});

				// 创建连接
				connectionData.forEach(function (connection) {
					instance.connect({
						source: connection.source,
						target: connection.target,
						endpoint: "Dot",
						anchor: "AutoDefault",
						connector: ["Flowchart", { stub: 20 }],
						paintStyle: connectorStyle,
					});
				});

				// 导出数据按钮点击事件处理程序
				$("#exportBtn").click(function () {
					var nodes = $(".node");
					var flowchartData = [];

					nodes.each(function () {
						var id = $(this).attr("id");
						var top = parseInt($(this).css("top"));
						var left = parseInt($(this).css("left"));
						var label = $(this).text();
						flowchartData.push({ id: id, top: top, left: left, label: label });
					});

					// 获取所有的连线数据
					var connections = instance.getConnections();
					var connectionData = [];

					connections.forEach(function (connection) {
						var sourceId = connection.sourceId;
						var targetId = connection.targetId;
						connectionData.push({ source: sourceId, target: targetId });
					});

					// 暂时存在本地
					console.log("flowchartData", flowchartData);
					console.log("connectionData", connectionData);
					window.localStorage.setItem("flowchartData", JSON.stringify(flowchartData));
					window.localStorage.setItem("connectionData", JSON.stringify(connectionData));
				});
			});

			// 添加节点按钮点击事件处理程序
			$("#addNodeBtn").click(function () {
				var newNodeId = "node" + (flowchartData.length + 1);
				var newNode = {
					id: newNodeId,
					top: 150,
					left: 400,
					label: "Node " + (flowchartData.length + 1),
				};

				// 添加新节点到数据列表
				flowchartData.push(newNode);

				// 创建新节点的 DOM 元素并添加到画布
				var newElement = $("<div>")
					.attr("id", newNode.id)
					.addClass("node")
					.css({
						top: newNode.top + "px",
						left: newNode.left + "px",
					})
					.text(newNode.label);
				$("#canvas").append(newElement);

				// 可拖拽
				instance.draggable(newElement, {
					containment: "parent",
				});

				// 更新数据
				window.localStorage.setItem("flowchartData", JSON.stringify(flowchartData));
			});
		</script>
	</body>
</html>
